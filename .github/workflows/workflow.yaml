name: Dev Database Migrations

on:
  push:
    branches:
      - dev

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: pdo, mysql
      - name: Install Composer dependencies
        run: composer install --no-interaction --no-dev --prefer-dist
      - name: Set up environment variables
        run: |
          echo "DB_HOST=localhost" >> .env
          echo "DB_DATABASE=laravel_gh_ost" >> .env
          echo "DB_USERNAME=root" >> .env
          echo "DB_PASSWORD=" >> .env
      - name: Debug git diff
        run: |
          echo "github.event.before: ${{ github.event.before }}"
          echo "Current HEAD: $(git rev-parse HEAD)"
          git diff ${{ github.event.before }} HEAD -- database/migrations/*.php
      - name: Run migrations with gh-ost and default migrations
        run: |
          php artisan config:clear
          MIGRATIONS=$(git diff --name-only ${{ github.event.before }} HEAD -- database/migrations/*.php)
          echo "Migrations found: $MIGRATIONS" # Print the list of migrations
          if [[ -n "$MIGRATIONS" ]]; then
            for migration in $MIGRATIONS; do
                GHOST_COMMAND=$(grep -oP 'gh-ost:.*' $migration)
                if [[ -n "$GHOST_COMMAND" ]]; then
                    echo "Running gh-ost migration: $GHOST_COMMAND --host=127.0.0.1"
                    eval "$GHOST_COMMAND --host=127.0.0.1"
                else
                    echo "Running default migration: $(basename $migration)"
                    php artisan migrate --path="$migration" --force
                fi
            done
          else
              echo "No new migration found."
          fi
      - name: Generate new key if it's new deployment for dev env
        run: php artisan key:generate